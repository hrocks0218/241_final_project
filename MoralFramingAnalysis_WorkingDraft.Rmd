---
title: "Can Exposure to Moral Foundations Affect Our Reactions to Policy Proposals?"
subtitle: "W241 Experiments and Causality (submitted December X, 2019)"
author: "Kevin Hartman, Hanna Rocks, Tim Spittle, and Jay Venkata"
date: "December 10, 2019"
tags: [T, B, D]
abstract: TBD
output:
  pdf_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
  md_document:
    variant: markdown
  html_document:
    df_print: paged
    toc: yes
---

```{r setup, include = FALSE}
rm(list=ls())

packages = c('openxlsx'
             , 'tidyverse', 'data.table'
             , 'visNetwork'
             , 'lmtest', 'sandwich', 'car'
             , 'gridExtra', 'stargazer', 'cowplot', 'corrplot'
             , 'knitr')
lapply(packages, library, character.only = TRUE)

stargazer_type = "text" # change to latex when ready to knit
```

\pagebreak

# Background  
_[[TBD]]_  

# Data  
_[[TBD]]_  

```{r import}
# Pilot
# results_panel1_raw = read.xlsx("./data/pilot/survey_results_pilot_panel1.xlsx") %>% filter(StartDate != "Start Date")
# results_panel2_raw = read.xlsx("./data/pilot/survey_results_pilot_panel2.xlsx") %>% filter(StartDate != "Start Date")
# participant_detail_panel1 = read.csv("./data/pilot/participant_detail_pilot_panel1.csv", stringsAsFactors = FALSE)
# participant_detail_panel2 = read.csv("./data/pilot/participant_detail_pilot_panel2.csv", stringsAsFactors = FALSE)

# Study
results_panel1_raw = read.xlsx("./data/study/MF Framing Pilot - Full Recruitment - Panel 1_November 20, 2019_07.25.xlsx") %>% filter(!grepl("Start|Import", StartDate))
results_panel2_raw = read.xlsx("./data/study/MF Framing Pilot - Full Recruitment - Panel 2_November 20, 2019_07.26.xlsx") %>% filter(!grepl("Start|Import", StartDate))
participant_detail_panel1 = read.csv("./data/study/prolific_export_5dd4a350108b6748b25b5de1.csv", stringsAsFactors = FALSE)
participant_detail_panel2 = read.csv("./data/study/prolific_export_5dd4a34135582248315dfdca.csv", stringsAsFactors = FALSE)
```

### Data Cleaning  
_[[TBD]]_  [^1]  

[^1]: _[[Example footnote]]_  

```{r data_cleaning}
results_full = bind_rows(results_panel1_raw %>% mutate(panel = 1)
                         , results_panel2_raw %>% mutate(panel = 2)) %>%
  mutate(arm = case_when(grepl('a', `FC-B_1`, ignore.case = TRUE) ~ "purity_base"
                         , grepl('a', `FC-C_1`, ignore.case = TRUE) ~ "purity_extension"
                         , grepl('a', `FC-D_1`, ignore.case = TRUE) ~ "fairness_base"
                         , grepl('a', `FC-E_1`, ignore.case = TRUE) ~ "fairness_extension"
                         , TRUE ~ "control") %>% factor()
         , node = paste0(arm, "_panel_", panel)) #%>%
  # merge(bind_rows(participant_detail_panel1, participant_detail_panel2)
  #       , by.x = "PROLIFIC_PID"
  #       , by.y = "participant_id"
  #       , all.x = TRUE) 

names(results_full) = gsub(x = names(results_full), pattern = "\\-|\\.", replacement = "_")  

# Discrete variables as factors (manual ordering for plotting)
ideology_levels = c("Very Liberal", "Lean Liberal", "Liberal", "Moderate", "Conservative", "Lean Conservative", "Very Conservative")
results_full$ideology = factor(results_full$PoliSpect, levels = ideology_levels)

results_full$UBI_number = as.numeric(results_full$UBI_2)

UBI_group_levels = c("Promoter", "Passive", "Detractor")
results_full$UBI_group = factor(results_full$UBI_2_NPS_GROUP, levels = UBI_group_levels)

UBI_familiarity_levels = c("Extremely familiar", "Very familiar", "Moderately familiar", "Slightly familiar", "Not familiar at all")
results_full$UBI_familiarity = factor(results_full$`UBI_F`, levels = UBI_familiarity_levels)
```

## Exploratory Analysis  
_[[TBD]]_  

### Study Setup  

```{r exploratory, fig.height = 4, fig.width = 4, fig.align="center", fig.cap="Study Setup"}
arm_counts = results_full %>%
  group_by(arm, panel, node) %>%
  summarise(count = n())

nodes = data.frame(
  id = 1:12
  , group = c("liberal", "conservative", arm_counts$arm)
  , label = c("liberal", "conservative", arm_counts$node)
  , value = c(sum(arm_counts$count[arm_counts$panel==1]), sum(arm_counts$count[arm_counts$panel==2]), arm_counts$count)
  # color, title, shape
  )

edges = data.frame(
  from = c(1, 2, 1, 2, 1, 2,  5, 6, 9,  10)
  , to = c(3, 4, 5, 6, 9, 10, 7, 8, 11, 12)
  )

visNetwork(nodes, edges) %>% 
  visHierarchicalLayout()
```

### Demographics  

```{r exploratory_demographics, fig.align="center", fig.cap="Demographics"}
# Ideology
ggplot(data = results_full %>%  group_by(ideology, panel) %>% summarise(count = n())
       , aes(x = ideology, y = count, fill = ideology)) +
  geom_bar(stat="identity") + 
  facet_grid( ~ panel) +
  scale_fill_brewer(type = "div", palette = 5, direction = -1, aesthetics = "fill") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Age
ggplot(data = results_full %>% group_by(Age, ideology, panel) %>% summarise(count = n())
       , aes(x = Age, y = count, fill = ideology)) +
  geom_bar(stat="identity") + 
  facet_grid( ~ panel) +
  scale_fill_brewer(type = "div", palette = 5, direction = -1, aesthetics = "fill") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Gender
ggplot(data = results_full %>% group_by(Gender, ideology, panel) %>% summarise(count = n())
       , aes(x = Gender, y = count, fill = ideology)) +
  geom_bar(stat="identity") + 
  facet_grid( ~ panel) +
  scale_fill_brewer(type = "div", palette = 5, direction = -1, aesthetics = "fill") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Urban
ggplot(data = results_full %>% group_by(Urban, ideology, panel) %>% summarise(count = n())
       , aes(x = Urban, y = count, fill = ideology)) +
  geom_bar(stat="identity") + 
  facet_grid( ~ panel) +
  scale_fill_brewer(type = "div", palette = 5, direction = -1, aesthetics = "fill") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Example reference to r cell _\autoref{fig:exploratory_demographics}_ shows _[[TBD]]_   

### Reactions  

```{r exploratory_reactions, fig.align="center", fig.cap="Reactions"}

# Histogram of familiarity
ggplot(data = results_full %>% group_by(UBI_familiarity, ideology, panel) %>% summarise(count = n())
       , aes(x = UBI_familiarity, y = count, fill = ideology)) +
  geom_bar(stat="identity") + 
  facet_grid( ~ panel) +
  scale_fill_brewer(type = "div", palette = 5, direction = -1, aesthetics = "fill") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Heat map of number UBI like
ggplot(data = results_full %>% group_by(UBI_familiarity, ideology) %>% summarise(UBI_number_avg = mean(UBI_number))
       , aes(x = UBI_familiarity, y = ideology, fill = UBI_number_avg)) +
  geom_tile() +
  scale_fill_distiller(palette = "Spectral") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

### Outcome  

```{r exploratory_outcome, fig.height = 4, fig.width = 4, fig.align="center", fig.cap="Outcomes"}

```

\pagebreak

# Methodology  

## Model 1  

**Independent variable**  

**Dependent variable**  

**Model specification**  

_[[TBD]]_. (see _\autoref{fig:model_1_explore}_)

```{r methodology_model_1_explore, fig.height = 3, fig.width = 4, fig.align="center", fig.cap="\\label{fig:model_1_explore}Model 1 - Exploratory Plot"}
# Exploratory
```

```{r methodology_model_1}
model_1 = lm(UBI_number ~ arm+panel, data = results_full)
stargazer(model_1, type = stargazer_type) 
```

_[[Example Table]]_  

| Model | Specification | Interpretation | Figure |
| :--- | :------ | :-------- | :--- |
| Model 1 | _crmrte~prbarr_ | $\Delta crmrte = \beta_1 \Delta prbarr$ | _\autoref{fig:model_1_fitplots}_ |

```{r methodology_model_1_final, results='asis', fig.cap="\\label{fig:model_1_final}"}
# Stargazer
```

\pagebreak

# Results  

_[[TBD]]_  

\pagebreak

# Conclusion  

_[[TBD]]_  

\pagebreak

# Discussion

_[[TBD]]_  

## Limitations

_[[TBD]]_   

\pagebreak

# Technical Appendix

## Data Dictionary

| Variable Name | Variable | Values | Source | Notes |
| :---- | :-------- | :-------- | :---------- | :----- |
| county | County ID | Odd Integers || Few missing |

\pagebreak

## Exploratory Data Analysis

**Additional steps taken not included in the body of the report**  

_[[TBD]]_  
